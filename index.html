<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SRT Translator.AI</title>
  <style>
    /* ... existing styles ... */
    .progress-container {
      width: 100%;
      max-width: 700px;
      height: 20px;
      background: #1c1c1c;
      border-radius: 10px;
      margin: 15px 0;
      display: none;
      box-shadow: 0 0 5px #00ffe7;
    }
    .progress-bar {
      height: 100%;
      background: #00ffe7;
      border-radius: 10px;
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <!-- ... existing HTML structure ... -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.3/dist/tesseract.min.js"></script>
  <script>
    // ====================
    // CORS FIXED SOLUTION
    // ====================
    async function safeTranslate(text, lang) {
      try {
        // 1. Using direct API call with CORS headers
        const res = await fetch("https://libretranslate.com/translate", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ 
            q: text, 
            source: "en", 
            target: lang,
            api_key: "free" // Required for new versions
          }),
        });
        
        if (!res.ok) {
          throw new Error(`API Error: ${res.status}`);
        }
        
        const data = await res.json();
        return data;
      } catch (e) {
        console.error("Translation Error:", e);
        showPopup();
        return { translatedText: `[TRANSLATION ERROR: ${e.message}]` };
      }
    }

    // ======================
    // VIDEO PROCESSING FIXES
    // ======================
    async function processVideoFrame(time) {
      return new Promise((resolve) => {
        videoPlayer.currentTime = time;
        videoPlayer.onseeked = async () => {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // Use actual video dimensions
          canvas.width = videoPlayer.videoWidth;
          canvas.height = videoPlayer.videoHeight;
          ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
          
          const yOffset = parseInt(document.getElementById('yOffset').value);
          const yHeight = parseInt(document.getElementById('yHeight').value);
          
          // Handle dynamic resolutions
          const frame = ctx.getImageData(
            0, 
            yOffset, 
            canvas.width, 
            yHeight
          );
          
          resolve(frame);
        };
      });
    }

    async function translateSubtitles() {
      // ... existing variable setup ...
      
      // Show progress UI
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      
      try {
        // Get accurate video duration
        if (isNaN(videoPlayer.duration) {
          await new Promise(resolve => 
            videoPlayer.onloadedmetadata = resolve
          );
        }
        
        const duration = videoPlayer.duration;
        const interval = 1; // seconds between frames
        let currentTime = 0;
        let srtEntries = [];
        let frameCount = 0;
        const totalFrames = Math.ceil(duration / interval);
        
        while (currentTime < duration) {
          const frame = await processVideoFrame(currentTime);
          
          // Update progress
          const progress = (currentTime / duration) * 100;
          progressBar.style.width = `${progress}%`;
          
          const result = await Tesseract.recognize(frame, 'eng', {
            logger: m => console.log(m)
          });
          
          const text = result.data.text.trim();
          if (text) {
            srtEntries.push({
              start: currentTime,
              end: currentTime + interval,
              text: text
            });
          }
          
          currentTime += interval;
          frameCount++;
        }
        
        // Generate SRT content
        let srtContent = "";
        for (let i = 0; i < srtEntries.length; i++) {
          const entry = srtEntries[i];
          const translation = await safeTranslate(entry.text, lang);
          
          srtContent += `${i+1}\n`;
          srtContent += `${formatTime(entry.start)} --> ${formatTime(entry.end)}\n`;
          srtContent += `${translation.translatedText}\n\n`;
        }
        
        // Download SRT
        const blob = new Blob([srtContent], { type: 'text/plain' });
        downloadFile(blob, 'translated_video.srt');
        
      } catch (error) {
        console.error("Processing Error:", error);
        showPopup();
      } finally {
        progressContainer.style.display = 'none';
      }
    }

    // Helper function for time formatting
    function formatTime(seconds) {
      const date = new Date(0);
      date.setSeconds(seconds);
      return date.toISOString().substr(11, 12).replace('.', ',');
    }

    // ... rest of your existing functions ...
  </script>
</body>
</html>